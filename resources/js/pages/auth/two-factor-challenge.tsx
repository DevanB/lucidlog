import { Form, Head } from '@inertiajs/react'
import { REGEXP_ONLY_DIGITS } from 'input-otp'
import { useMemo, useState } from 'react'
import { v4 as uuidv4 } from 'uuid'
import InputError from '@/components/input-error'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { InputOTP, InputOTPGroup, InputOTPSlot } from '@/components/ui/input-otp'
import { OTP_MAX_LENGTH } from '@/hooks/use-two-factor-auth'
import AuthLayout from '@/layouts/auth-layout'
import { store } from '@/routes/two-factor/login'

export default function TwoFactorChallenge() {
  const [showRecoveryInput, setShowRecoveryInput] = useState<boolean>(false)
  const [code, setCode] = useState<string>('')

  // Generate stable UUIDs for OTP slots once per component mount
  const slotKeys = useMemo(() => Array.from({ length: OTP_MAX_LENGTH }, () => uuidv4()), [])

  const authConfigContent = showRecoveryInput
    ? {
        title: 'Recovery Code',
        description: 'Please confirm access to your account by entering one of your emergency recovery codes.',
        toggleText: 'login using an authentication code',
      }
    : {
        title: 'Authentication Code',
        description: 'Enter the authentication code provided by your authenticator application.',
        toggleText: 'login using a recovery code',
      }

  const toggleRecoveryMode = (clearErrors: () => void): void => {
    setShowRecoveryInput((prev) => !prev)
    clearErrors()
    setCode('')
  }

  return (
    <AuthLayout description={authConfigContent.description} title={authConfigContent.title}>
      <Head title="Two-Factor Authentication" />

      <div className="space-y-6">
        <Form {...store.form()} className="space-y-4" resetOnError resetOnSuccess={!showRecoveryInput}>
          {({ errors, processing, clearErrors }) => (
            <>
              {showRecoveryInput ? (
                <>
                  <Input
                    autoFocus={showRecoveryInput}
                    name="recovery_code"
                    placeholder="Enter recovery code"
                    required
                    type="text"
                  />
                  <InputError message={errors.recovery_code} />
                </>
              ) : (
                <div className="flex flex-col items-center justify-center space-y-3 text-center">
                  <div className="flex w-full items-center justify-center">
                    <InputOTP
                      disabled={processing}
                      maxLength={OTP_MAX_LENGTH}
                      name="code"
                      onChange={(value) => setCode(value)}
                      pattern={REGEXP_ONLY_DIGITS}
                      value={code}
                    >
                      <InputOTPGroup>
                        {Array.from({ length: OTP_MAX_LENGTH }, (_, index) => (
                          <InputOTPSlot index={index} key={slotKeys[index]} />
                        ))}
                      </InputOTPGroup>
                    </InputOTP>
                  </div>
                  <InputError message={errors.code} />
                </div>
              )}

              <Button className="w-full" disabled={processing} type="submit">
                Continue
              </Button>

              <div className="text-center text-muted-foreground text-sm">
                <span>or you can </span>
                <button
                  className="cursor-pointer text-foreground underline decoration-neutral-300 underline-offset-4 transition-colors duration-300 ease-out hover:decoration-current! dark:decoration-neutral-500"
                  onClick={() => toggleRecoveryMode(clearErrors)}
                  type="button"
                >
                  {authConfigContent.toggleText}
                </button>
              </div>
            </>
          )}
        </Form>
      </div>
    </AuthLayout>
  )
}
